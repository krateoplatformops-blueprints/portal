apiVersion: widgets.templates.krateo.io/v1beta1
kind: Table
metadata:
  name: dashboard-blueprints-panel-row-table
  namespace: {{ .Release.Namespace }}
  annotations:
    "krateo.io/verbose": "true"
spec:
  widgetData:
    allowedResources: []
    columns:
    - title: Name
      valueKey: name
    - title: Namespace
      valueKey: namespace
    - title: Status
      valueKey: status
    - title: Date
      valueKey: date
    - title: Kind
      valueKey: kind
    - title: ApiVersion
      valueKey: apiversion
    data: []
    pageSize: 10
  widgetDataTemplate:
    - forPath: data
      expression: >
        ${
          (
            .list
            | map([
                {
                  valueKey: "key",
                  kind: "jsonSchemaType",
                  type: "string",
                  stringValue: .metadata.uid
                },
                {
                  valueKey: "name",
                  kind: "jsonSchemaType",
                  type: "string",
                  stringValue: .metadata.name
                },
                {
                  valueKey: "namespace",
                  kind: "jsonSchemaType",
                  type: "string",
                  stringValue: .metadata.namespace
                },
                {
                  valueKey: "date",
                  kind: "jsonSchemaType",
                  type: "string",
                  stringValue: .metadata.creationTimestamp
                },
                {
                  valueKey: "status",
                  kind: "jsonSchemaType",
                  type: "string",
                  stringValue: (
                    if (.status? and .status.conditions?) then
                      (.status.conditions[]? | select(.type == "Ready") | "Ready: " + .status)?
                      // "Status not available"
                    else
                      "Status not available"
                    end
                  )
                },
                {
                  valueKey: "kind",
                  kind: "jsonSchemaType",
                  type: "string",
                  stringValue: .kind
                },
                {
                  valueKey: "apiversion",
                  kind: "jsonSchemaType",
                  type: "string",
                  stringValue: .apiVersion
                }
              ])
            # Each row is now an array of cells â†’ sort by the "date" cell's stringValue
            | sort_by( ([.[] | select(.valueKey == "date") | .stringValue] | first) )
            | reverse
          )
        }
  apiRef:
    name: blueprints-list
    namespace: {{ .Release.Namespace }}